#!/bin/bash

## https://github.com/9001/copyparty

## Writes an ephemeral config file using this script as the source of truth.
## Starts a PUBLIC copyparty server rooted in the current directory.

set -e

W_DIR="$(realpath $(dirname ${BASH_SOURCE}))"
CFG_DIR=$(mktemp -d)
PID="$$"
ADMIN_PASSWORD=$(head /dev/urandom | tr -dc A-Za-z0-9 | head -c 16)

cat <<EOF > ${CFG_DIR}/copyparty.conf
[global]
  e2dsa  # enable file indexing and filesystem scanning
  e2ts   # enable multimedia indexing
  ansi   # enable colors in log messages

  # q, lo: /cfg/log/%Y-%m%d.log   # log to file instead of docker

  df: 16           # stop accepting uploads if less than 16 GB free disk space
  # p: 3939          # listen on another port
  # ipa: 10.89.      # only allow connections from 10.89.*
  # ver              # show copyparty version in the controlpanel
  # grid             # show thumbnails/grid-view by default
  # theme: 2         # monokai
  # name: datasaver  # change the server-name that's displayed in the browser
  # stats, nos-dup   # enable the prometheus endpoint, but disable the dupes counter (too slow)
  # no-robots, force-js  # make it harder for search engines to read your server


[accounts]
  admin: ${ADMIN_PASSWORD}


[/]            # create a volume at "/" (the webroot), which will
  /w           # share /w (the docker data volume)
  accs:
    rw: *         # everyone gets read-write access, but
    rwmda: admin  # the user "admin" gets read-write-move-delete-admin
EOF

echo "ADMIN_PASSWORD: ${ADMIN_PASSWORD}"
set -x
podman run --rm -it --name "copyparty_${PID}" -p 3923:3923 -v ${CFG_DIR}:/cfg:Z -v .:/w:Z docker.io/copyparty/ac $@
